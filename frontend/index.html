<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Live Server</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">SERVER / STATUS</div>
        <nav class="nav">
            <a href="#" class="nav-item">CONTACT</a>
            <a href="#" class="nav-item">ABOUT</a>
        </nav>
    </header>

    <main class="container">
        <section class="hero">
            <h1>Server Status.<span class="dot">.</span></h1>
            <p class="subtitle">Live System Metrics & Configuration.</p>
        </section>

        <section class="metrics-grid">
            
            <div class="metric-card full-width" id="streaming-card">
                <div class="metric-label">Mediatheque & Streaming Activity</div>
                <div class="library-counts">
                    <div class="library-stat">
                        <span class="count">1923</span>
                        <span class="label">Movies</span>
                    </div>
                    <div class="library-stat">
                        <span class="count">812</span>
                        <span class="label">Shows</span>
                    </div>
                    <div class="library-stat">
                        <span class="count">350</span>
                        <span class="label">Animes</span>
                    </div>
                </div>
                <div class="streaming-activity">
                    <div class="activity-stat">
                        <i class="fas fa-play-circle"></i> 2 currently playing
                    </div>
                    <div class="activity-stat">
                        <i class="fas fa-cogs"></i> 1 active transcoding
                    </div>
                </div>
            </div>

            <div class="metric-card" id="cpu-card">
                <div class="metric-label">CPU Usage & Temp</div>
                <div class="cpu-main-stats">
                    <div class="cpu-usage-value">
                        <span class="metric-value" id="cpu-usage">--%</span>
                    </div>
                    <div class="cpu-temp-value">
                        <i class="fas fa-thermometer-half"></i>
                        <span id="cpu-temp">--.-°C</span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="cpu-progress-bar"></div>
                </div>
            </div>

            <div class="metric-card" id="ram-card">
                <div class="metric-label">RAM USAGE</div>
                <div class="card-body">
                    <div class="ram-usage-main" id="ram-usage-gb">--.- GB / ---.- GB</div>
                    <div class="ram-usage-percent" id="ram-usage-percent">(--.-%)</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="ram-progress-bar"></div>
                </div>
            </div>
            
            <div class="metric-card" id="docker-card">
                <div class="metric-label">Docker Activity</div>
                <div class="metric-value with-icon">
                    <i class="fab fa-docker"></i>
                    <span id="docker-containers">22</span>
                </div>
                <div class="secondary-stats">
                    <div class="stat-item">
                        <span>Images</span>
                        <span id="docker-images">128</span>
                    </div>
                    <div class="stat-item">
                        <span>Volumes</span>
                        <span id="docker-volumes">35</span>
                    </div>
                </div>
            </div>

            <div class="metric-card" id="network-card">
                <div class="metric-label">Network Traffic</div>
                <div class="network-current-stats">
                    <div class="network-stat">
                        <span><i class="fas fa-arrow-down"></i> In</span>
                        <span id="net-in">--.- Mb/s</span>
                    </div>
                    <div class="network-stat">
                        <span><i class="fas fa-arrow-up"></i> Out</span>
                        <span id="net-out">--.- Mb/s</span>
                    </div>
                </div>
                <div class="network-chart-container">
                    <canvas id="networkChart"></canvas>
                </div>
            </div>

            <div class="metric-card full-width" id="zfs-card">
                <div class="metric-label">ZFS Pool Configuration</div>
                <div class="zfs-header">
                    <span class="pool-name"><i class="fas fa-database"></i> rpool</span>
                    <span class="pool-status online"><i class="fas fa-check-circle"></i> ONLINE</span>
                </div>
                <div class="zfs-layout">
                    <div class="zfs-column">
                        <span class="column-title">Data VDEVs</span>
                        <ul class="zfs-tree">
                            <li><i class="fas fa-layer-group"></i> raidz1-0 <span class="device-status">ONLINE</span>
                                <ul>
                                    <li><i class="fas fa-hdd"></i> disk-01</li>
                                    <li><i class="fas fa-hdd"></i> disk-02</li>
                                    <li><i class="fas fa-hdd"></i> disk-03</li>
                                    <li><i class="fas fa-hdd"></i> disk-04</li>
                                </ul>
                            </li>
                            <li><i class="fas fa-layer-group"></i> raidz1-1 <span class="device-status">ONLINE</span>
                                <ul>
                                    <li><i class="fas fa-hdd"></i> disk-05</li>
                                    <li><i class="fas fa-hdd"></i> disk-06</li>
                                    <li><i class="fas fa-hdd"></i> disk-07</li>
                                    <li><i class="fas fa-hdd"></i> disk-08</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div class="zfs-column">
                        <span class="column-title">Cache VDEV</span>
                        <ul class="zfs-tree">
                            <li><i class="fas fa-bolt"></i> L2ARC
                                <ul>
                                    <li><i class="fas fa-microchip"></i> nvme-Samsung-970-Evo</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="metric-card large-card">
                <div class="metric-label">ARC & L2ARC Cache Performance</div>
                <div class="cache-stats-container">
                    <div class="cache-chart-container">
                        <svg viewBox="0 0 36 36" class="cache-chart">
                            <path class="chart-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                            <path class="chart-circle" stroke-dasharray="97, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                            <text x="18" y="20.35" class="chart-text">97%</text>
                        </svg>
                        <div class="chart-label">ARC Hit Rate</div>
                    </div>
                    <div class="cache-details">
                        <div class="cache-stat">
                            <span>ARC Size (RAM)</span>
                            <span class="stat-value">64.5 GB</span>
                        </div>
                        <div class="cache-stat">
                            <span>ARC Max Size</span>
                            <span class="stat-value">65.0 GB</span>
                        </div>
                        <hr>
                        <div class="cache-stat">
                            <span>L2ARC Size (NVMe)</span>
                            <span class="stat-value">480.1 GB</span>
                        </div>
                        <div class="cache-stat">
                            <span>L2ARC Hit Rate</span>
                            <span class="stat-value">68.2 %</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">System Information</div>
                <ul class="sysinfo-list">
                    <li><span>OS</span><span>Debian 12 Bookworm</span></li>
                    <li><span>Kernel</span><span>6.1.0-18-amd64</span></li>
                    <li><span>CPU</span><span>AMD Ryzen 7 5800X</span></li>
                </ul>
            </div>
        </section>
    </main>
    <script>
        const ctx = document.getElementById('networkChart').getContext('2d');
    const networkChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(30).fill(''), // 30 points de données (1 minute à 2s d'intervalle)
            datasets: [{
                label: 'In (Mb/s)',
                data: Array(30).fill(0),
                borderColor: 'rgba(0, 123, 255, 0.8)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4,
                fill: true,
            }, {
                label: 'Out (Mb/s)',
                data: Array(30).fill(0),
                borderColor: 'rgba(40, 167, 69, 0.8)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4,
                fill: true,
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: 10 } }
                },
                x: {
                    ticks: { display: false }
                }
            },
            plugins: {
                legend: { display: false }
            },
            animation: { duration: 250 }
        }
    });

    const socket = new WebSocket(`ws://${window.location.host}/ws`);

    socket.onopen = function(event) {
        console.log('Connexion WebSocket établie !');
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Données reçues:', data);

        function updateTextContent(selector, value) {
            const element = document.querySelector(selector);
            if (element) { element.textContent = value; }
        }

        function updateProgressBar(selector, value) {
            const element = document.querySelector(selector);
            if (element) { element.style.width = value; }
        }

        // --- CPU Usage & Temp ---
        updateTextContent('#cpu-usage', data.cpu.usage);
        updateTextContent('#cpu-temp', data.cpu.temp);
        const cpuProgressBar = document.querySelector('#cpu-progress-bar');
        if (cpuProgressBar) {
            cpuProgressBar.style.width = data.cpu.usage;
        }

        // RAM Usage
        updateTextContent('#ram-usage-gb', `${data.ram.used} / ${data.ram.total}`);
        updateTextContent('#ram-usage-percent', `(${data.ram.percent})`);
        updateProgressBar('#ram-progress-bar', data.ram.percent);

        // Docker Activity
        updateTextContent('#docker-containers', data.docker.containers);
        updateTextContent('#docker-images', data.docker.images);
        updateTextContent('#docker-volumes', data.docker.volumes);

        // Streaming Info
        updateTextContent('#streaming-card .library-stat:nth-child(1) .count', data.streaming.films);
        updateTextContent('#streaming-card .library-stat:nth-child(2) .count', data.streaming.series);
        updateTextContent('#streaming-card .library-stat:nth-child(3) .count', data.streaming.animes);
        
        const playingElement = document.querySelector('.streaming-activity .activity-stat:nth-child(1)');
        if (playingElement) { playingElement.innerHTML = `<i class="fas fa-play-circle"></i> ${data.streaming.playing} Media currently playing`; }
        
        const transcodingElement = document.querySelector('.streaming-activity .activity-stat:nth-child(2)');
        if (transcodingElement) { transcodingElement.innerHTML = `<i class="fas fa-cogs"></i> ${data.streaming.transcoding} Active transcoding`; }

        // ARC & L2ARC Cache Performance
        const arcCircle = document.querySelector('.cache-chart .chart-circle');
        if (arcCircle) { arcCircle.setAttribute('stroke-dasharray', `${data.arcCache.arcHitRateNum}, 100`); }
        updateTextContent('.cache-chart .chart-text', data.arcCache.arcHitRate);
        updateTextContent('.cache-details .cache-stat:nth-child(1) .stat-value', data.arcCache.arcSize);
        updateTextContent('.cache-details .cache-stat:nth-child(2) .stat-value', data.arcCache.arcMaxSize);
        updateTextContent('.cache-details .cache-stat:nth-child(4) .stat-value', data.arcCache.l2arcSize);
        updateTextContent('.cache-details .cache-stat:nth-child(5) .stat-value', data.arcCache.l2arcHitRate);

        // -- LIGNES AJOUTÉES ICI --
        // System Information
        updateTextContent('.sysinfo-list li:nth-child(1) span:last-child', data.system.os);
        updateTextContent('.sysinfo-list li:nth-child(2) span:last-child', data.system.kernel);
        updateTextContent('.sysinfo-list li:nth-child(3) span:last-child', data.system.cpu);

        if (data.zfsConfig && data.zfsConfig.poolName) {
            // Mise à jour de l'en-tête
            updateTextContent('#zfs-card .pool-name', data.zfsConfig.poolName);
            const statusElement = document.querySelector('#zfs-card .pool-status');
            if (statusElement) {
                statusElement.textContent = data.zfsConfig.poolStatus;
                statusElement.className = 'pool-status ' + data.zfsConfig.poolStatus.toLowerCase();
            }

            // Sélection des listes où on va insérer les vdevs
            const dataVdevTree = document.querySelector('#zfs-card .zfs-column:nth-child(1) .zfs-tree');
            const cacheVdevTree = document.querySelector('#zfs-card .zfs-column:nth-child(2) .zfs-tree');

            if (dataVdevTree && cacheVdevTree) {
                // On vide les listes avant de les reconstruire
                dataVdevTree.innerHTML = '';
                cacheVdevTree.innerHTML = '';

                // On construit les vdevs de données
                data.zfsConfig.dataVdevs.forEach(vdev => {
                    const vdevLi = document.createElement('li');
                    let devicesHtml = '<ul>';
                    vdev.devices.forEach(device => {
                        devicesHtml += `<li><i class="fas fa-hdd"></i> ${device}</li>`;
                    });
                    devicesHtml += '</ul>';
                    vdevLi.innerHTML = `<i class="fas fa-layer-group"></i> ${vdev.name} <span class="device-status">${vdev.status}</span>${devicesHtml}`;
                    dataVdevTree.appendChild(vdevLi);
                });

                // On construit le vdev de cache (s'il existe)
                if (data.zfsConfig.cacheVdev) {
                    const vdev = data.zfsConfig.cacheVdev;
                    const vdevLi = document.createElement('li');
                    let devicesHtml = '<ul>';
                    vdev.devices.forEach(device => {
                        devicesHtml += `<li><i class="fas fa-microchip"></i> ${device}</li>`;
                    });
                    devicesHtml += '</ul>';
                    vdevLi.innerHTML = `<i class="fas fa-bolt"></i> ${vdev.name} <span class="device-status">${vdev.status}</span>${devicesHtml}`;
                    cacheVdevTree.appendChild(vdevLi);
                }
            }
        }

        // Mise à jour CPU (maintenant avec la température)
        updateTextContent('#cpu-usage', data.cpu.usage);
        updateProgressBar('#cpu-usage + .progress-bar-container .progress-bar', data.cpu.usage);
        
        // NOUVELLES LIGNES POUR LA TEMPÉRATURE
        updateTextContent('#cpu-temp', data.cpu.temp);
        const tempGauge = document.querySelector('.gauge-fill');
        if (tempGauge) {
            // La jauge tourne de 0 à 180deg pour une température de 0 à 100°C
            const tempRotation = (data.cpu.tempDeg / 100) * 180;
            tempGauge.style.transform = `rotate(${tempRotation}deg)`;
        }

        updateTextContent('#net-in', data.net.in);
        updateTextContent('#net-out', data.net.out);

        // On met à jour les données du graphique
        const chartData = networkChart.data;
        
        // Ajoute la nouvelle valeur et retire la plus ancienne
        chartData.datasets[0].data.push(parseFloat(data.net.in) || 0);
        chartData.datasets[0].data.shift();
        
        chartData.datasets[1].data.push(parseFloat(data.net.out) || 0);
        chartData.datasets[1].data.shift();
        
        networkChart.update();
    };

    socket.onclose = function(event) {
        console.log('Connexion WebSocket fermée.');
    };

    socket.onerror = function(error) {
        console.error('Erreur WebSocket:', error);
    };
    </script>
</body>
</html>